{% extends 'base.html' %}

{% block title %}Your Dashboard - Masterify{% endblock %}

{% block head %}
<style>
    /* Dashboard specific styling */
    .dashboard-card {
        transition: all 0.3s ease;
    }
    
    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
    }
    
    .credits-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    .file-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 0.375rem;
        background-color: rgba(99, 102, 241, 0.1);
        color: #6366F1;
        font-size: 18px;
    }
    
    /* Waveform preview */
    .waveform-mini {
        width: 100%;
        height: 40px;
        background-color: rgba(99, 102, 241, 0.05);
        border-radius: 0.25rem;
        overflow: hidden;
    }
    
    /* Tab navigation */
    .tab-nav {
        display: flex;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .tab-button {
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        border-bottom: 3px solid transparent;
        transition: all 0.2s ease;
    }
    
    .tab-button.active {
        color: #6366F1;
        border-bottom-color: #6366F1;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<section class="py-12 bg-gray-50">
    <div class="container mx-auto px-4">
        <div class="max-w-6xl mx-auto">
            <!-- Dashboard Header -->
            <div class="mb-8 flex flex-col md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 class="text-3xl font-bold mb-2">Welcome, <span class="user-name">{{ user.username }}</span></h1>
                    <p class="text-gray-600">Manage your mastered tracks and credits</p>
                </div>
                
                <div class="mt-4 md:mt-0">
                    <div class="flex items-center space-x-4">
                        <div class="credits-badge bg-indigo-100 text-indigo-800">
                            <i class="fas fa-coins mr-2"></i>
                            <span class="user-credits">{{ user.credits }}</span> credit{{ user.credits != 1 ? 's' : '' }}
                        </div>
                        <a href="/pricing" class="btn-outline-primary px-4 py-2 rounded-md">
                            Buy More Credits
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Dashboard Tabs -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
                <nav class="tab-nav">
                    <button class="tab-button active" data-tab="mastered-files">
                        <i class="fas fa-music mr-2"></i> Your Mastered Files
                    </button>
                    <button class="tab-button" data-tab="account">
                        <i class="fas fa-user mr-2"></i> Account Settings
                    </button>
                    <button class="tab-button" data-tab="billing">
                        <i class="fas fa-credit-card mr-2"></i> Billing & Credits
                    </button>
                </nav>
                
                <!-- Mastered Files Tab -->
                <div id="mastered-files" class="tab-content active p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold">Your Mastered Tracks</h2>
                        <a href="/upload" class="btn-primary px-4 py-2 rounded-md text-sm">
                            <i class="fas fa-plus mr-2"></i> Master New Track
                        </a>
                    </div>
                    
                    <!-- File List -->
                    <div id="file-list">
                        <!-- Loading state -->
                        <div id="loading-files" class="py-8 text-center text-gray-500">
                            <div class="spinner text-4xl text-indigo-600 mb-4">
                                <i class="fas fa-circle-notch"></i>
                            </div>
                            <p>Loading your mastered files...</p>
                        </div>
                        
                        <!-- Empty state -->
                        <div id="no-files" class="py-12 text-center hidden">
                            <div class="text-5xl text-indigo-300 mb-4">
                                <i class="fas fa-file-audio"></i>
                            </div>
                            <h3 class="text-xl font-semibold mb-2">No mastered files yet</h3>
                            <p class="text-gray-600 mb-6">
                                Upload your first track to get started with Masterify
                            </p>
                            <a href="/upload" class="btn-primary px-6 py-3 rounded-md">
                                Master Your First Track
                            </a>
                        </div>
                        
                        <!-- File items will be dynamically inserted here -->
                        <div id="file-items" class="space-y-4 hidden">
                            <!-- Example file item (for reference, will be replaced by JS) -->
                            <div class="mastered-file-card p-4 rounded-lg flex flex-col md:flex-row md:items-center">
                                <div class="file-icon mr-4 mb-4 md:mb-0">
                                    <i class="fas fa-file-audio"></i>
                                </div>
                                <div class="flex-grow mb-4 md:mb-0">
                                    <h3 class="font-semibold">Example Track.mp3</h3>
                                    <div class="flex flex-col sm:flex-row sm:items-center text-sm text-gray-600">
                                        <span class="mr-4">
                                            <i class="fas fa-calendar-alt mr-1"></i> Jan 1, 2023
                                        </span>
                                        <span class="mr-4">
                                            <i class="fas fa-clock mr-1"></i> 3:45
                                        </span>
                                        <span>
                                            <i class="fas fa-sliders-h mr-1"></i> Clean Preset
                                        </span>
                                    </div>
                                    <div class="waveform-mini mt-2"></div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button class="play-button p-2 rounded-full bg-indigo-100 text-indigo-600 hover:bg-indigo-200">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    <a href="#" class="download-button p-2 rounded-full bg-indigo-600 text-white hover:bg-indigo-700">
                                        <i class="fas fa-download"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Account Settings Tab -->
                <div id="account" class="tab-content p-6">
                    <h2 class="text-xl font-semibold mb-6">Account Settings</h2>
                    
                    <form id="account-form" class="max-w-2xl">
                        <div class="mb-6">
                            <label for="account-username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                            <input type="text" id="account-username" name="username" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md" value="{{ user.username }}">
                        </div>
                        
                        <div class="mb-6">
                            <label for="account-email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                            <input type="email" id="account-email" name="email" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md" value="{{ user.email }}">
                        </div>
                        
                        <h3 class="text-lg font-semibold mb-4 mt-8">Change Password</h3>
                        
                        <div class="mb-6">
                            <label for="current-password" class="block text-sm font-medium text-gray-700 mb-1">Current Password</label>
                            <input type="password" id="current-password" name="current_password" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        
                        <div class="mb-6">
                            <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
                            <input type="password" id="new-password" name="new_password" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        
                        <div class="mb-8">
                            <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">Confirm New Password</label>
                            <input type="password" id="confirm-password" name="confirm_password" class="form-input w-full px-3 py-2 border border-gray-300 rounded-md">
                        </div>
                        
                        <div id="account-message" class="mb-6 hidden">
                            <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative">
                                <span id="account-message-text">Settings updated successfully!</span>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn-primary px-6 py-3 rounded-md">
                            Save Changes
                        </button>
                    </form>
                </div>
                
                <!-- Billing & Credits Tab -->
                <div id="billing" class="tab-content p-6">
                    <h2 class="text-xl font-semibold mb-6">Billing & Credits</h2>
                    
                    <div class="dashboard-card bg-gray-50 p-6 rounded-lg mb-8">
                        <div class="flex items-center mb-4">
                            <div class="text-3xl text-indigo-600 mr-4">
                                <i class="fas fa-coins"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold">Your Credits</h3>
                                <p class="text-gray-600">Use credits to master your audio tracks</p>
                            </div>
                        </div>
                        
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                            <div class="text-4xl font-bold mb-4 md:mb-0">
                                <span class="user-credits">{{ user.credits }}</span>
                                <span class="text-gray-500 text-xl">credit{{ user.credits != 1 ? 's' : '' }} remaining</span>
                            </div>
                            
                            <a href="/pricing" class="btn-primary px-6 py-3 rounded-md">
                                Purchase More Credits
                            </a>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-semibold mb-4">Credit History</h3>
                    
                    <div class="bg-white border rounded-lg overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Credits</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Balance</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="credit-history">
                                <!-- Empty state -->
                                <tr id="no-credits" class="text-center">
                                    <td colspan="4" class="px-6 py-12">
                                        <div class="text-4xl text-indigo-300 mb-4">
                                            <i class="fas fa-receipt"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold mb-2">No credit history yet</h3>
                                        <p class="text-gray-600">
                                            Your credit transactions will appear here
                                        </p>
                                    </td>
                                </tr>
                                
                                <!-- Credit history items will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tab functionality
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const tabId = this.dataset.tab;
                
                // Update active tab button
                tabButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                // Update active tab content
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(tabId).classList.add('active');
                
                // Load data for the selected tab if needed
                if (tabId === 'mastered-files') {
                    loadMasteredFiles();
                }
            });
        });
        
        // Load mastered files
        async function loadMasteredFiles() {
            const loadingFiles = document.getElementById('loading-files');
            const noFiles = document.getElementById('no-files');
            const fileItems = document.getElementById('file-items');
            
            // Show loading state
            loadingFiles.classList.remove('hidden');
            noFiles.classList.add('hidden');
            fileItems.classList.add('hidden');
            
            try {
                const response = await axios.get('/api/files');
                if (response.data.success) {
                    const files = response.data.files;
                    
                    if (files.length === 0) {
                        // Show empty state
                        loadingFiles.classList.add('hidden');
                        noFiles.classList.remove('hidden');
                        return;
                    }
                    
                    // Generate file items
                    fileItems.innerHTML = '';
                    files.forEach(file => {
                        const fileElement = createFileElement(file);
                        fileItems.appendChild(fileElement);
                    });
                    
                    // Show file items
                    loadingFiles.classList.add('hidden');
                    fileItems.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading files:', error);
                loadingFiles.classList.add('hidden');
                
                // Show error message
                fileItems.innerHTML = `
                    <div class="py-8 text-center text-red-500">
                        <div class="text-4xl mb-4">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <p>Error loading your files. Please try again later.</p>
                    </div>
                `;
                fileItems.classList.remove('hidden');
            }
        }
        
        // Create file element
        function createFileElement(file) {
            const fileDate = new Date(file.created_at).toLocaleDateString();
            const duration = formatDuration(file.duration);
            
            const fileElement = document.createElement('div');
            fileElement.className = 'mastered-file-card p-4 rounded-lg flex flex-col md:flex-row md:items-center';
            
            fileElement.innerHTML = `
                <div class="file-icon mr-4 mb-4 md:mb-0">
                    <i class="fas fa-file-audio"></i>
                </div>
                <div class="flex-grow mb-4 md:mb-0">
                    <h3 class="font-semibold">${file.original_filename}</h3>
                    <div class="flex flex-col sm:flex-row sm:items-center text-sm text-gray-600">
                        <span class="mr-4">
                            <i class="fas fa-calendar-alt mr-1"></i> ${fileDate}
                        </span>
                        <span class="mr-4">
                            <i class="fas fa-clock mr-1"></i> ${duration}
                        </span>
                        <span>
                            <i class="fas fa-sliders-h mr-1"></i> ${capitalizeFirstLetter(file.preset_used)} Preset
                        </span>
                    </div>
                    <div class="waveform-mini mt-2" id="waveform-${file.id}"></div>
                </div>
                <div class="flex items-center space-x-2">
                    <a href="/api/download/${file.id}" class="download-button p-2 rounded-full bg-indigo-600 text-white hover:bg-indigo-700">
                        <i class="fas fa-download"></i>
                    </a>
                </div>
            `;
            
            return fileElement;
        }
        
        // Helper function to format duration
        function formatDuration(seconds) {
            if (!seconds) return '0:00';
            
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        // Helper function to capitalize first letter
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        // Account form submission
        const accountForm = document.getElementById('account-form');
        if (accountForm) {
            accountForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Get form data
                const formData = new FormData(accountForm);
                const newPassword = formData.get('new_password');
                const confirmPassword = formData.get('confirm_password');
                
                // Simple validation
                if (newPassword && newPassword !== confirmPassword) {
                    const accountMessage = document.getElementById('account-message');
                    const accountMessageText = document.getElementById('account-message-text');
                    
                    accountMessage.classList.remove('hidden');
                    accountMessage.classList.remove('bg-green-100', 'border-green-400', 'text-green-700');
                    accountMessage.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
                    accountMessageText.textContent = 'Passwords do not match!';
                    
                    return;
                }
                
                // Display success message (in a real app, this would send data to the server)
                const accountMessage = document.getElementById('account-message');
                const accountMessageText = document.getElementById('account-message-text');
                
                accountMessage.classList.remove('hidden');
                accountMessage.classList.remove('bg-red-100', 'border-red-400', 'text-red-700');
                accountMessage.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
                accountMessageText.textContent = 'Settings updated successfully!';
                
                // Clear password fields
                accountForm.reset();
                
                // In a real implementation, this would be an API call:
                /*
                axios.post('/api/update-account', {
                    username: formData.get('username'),
                    email: formData.get('email'),
                    current_password: formData.get('current_password'),
                    new_password: newPassword
                })
                .then(response => {
                    accountMessage.classList.remove('hidden');
                    accountMessage.classList.remove('bg-red-100', 'border-red-400', 'text-red-700');
                    accountMessage.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
                    accountMessageText.textContent = 'Settings updated successfully!';
                    
                    // Update username in UI
                    const userNameElements = document.querySelectorAll('.user-name');
                    userNameElements.forEach(el => {
                        el.textContent = formData.get('username');
                    });
                })
                .catch(error => {
                    accountMessage.classList.remove('hidden');
                    accountMessage.classList.remove('bg-green-100', 'border-green-400', 'text-green-700');
                    accountMessage.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
                    accountMessageText.textContent = error.response?.data?.message || 'Error updating settings';
                });
                */
            });
        }
        
        // Initialize dashboard
        loadMasteredFiles();
    });
</script>
{% endblock %}
